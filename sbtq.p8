pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include sbtq_tete.pinc

g_sea_level = 5

g_buoy = 0.1
g_drag = 1 - 0.1
g_repell = .025

g_bubbles = {}

c_state_title=1
c_state_game=2
c_state_text=3

c_levels={
    {
        triggers={
            {x=30,y=64,w=16,h=8},
            {x=98,y=64,w=16,h=8},
        }
    }
}

g_leveli=1

g_state=c_state_title

function bbl(x, y, dx, dy, buoy, r)
    bulle = {
        x = x,
        y = y,
        dx = dx,
        dy = dy,
        buoy = buoy,
        radius = r,
        radius_sq = r * r
    }

    g_bubbles[#g_bubbles + 1] = bulle
end

function dist_sq(o1, o2)
    x = o2.x - o1.x
    y = o2.y - o1.y
    return (x * x) + (y * y)
end

bbl(64, 96, -1, 0, g_buoy, 5)
bbl(64, 32, 0, 0, 0, 10)
bbl(64, 02, 0, 0, -.02, 1)

function _update60()
    if g_state==c_state_title then
        if btnp(4) or btnp(5) then
            g_state=c_state_game
        end
    elseif g_state==c_state_game then
        for index=1,#g_bubbles do
            o1 = g_bubbles[index]
            for jndex=1,#g_bubbles do
                if index == jndex then
                    goto continue
                end

                o2 = g_bubbles[jndex]
                sq = dist_sq(o1, o2)
                sq_sum = o1.radius_sq + o2.radius_sq 
                if sq > sq_sum then
                    goto continue
                end
                
                f = g_repell 

                o1.dx -= (o2.x - o1.x) * f
                o1.dy += (o2.y - o1.y) * f

                ::continue::
            end
        end

        for index=1,#g_bubbles do
            bulle = g_bubbles[index]
            bulle.x += bulle.dx
            bulle.y -= bulle.dy
            bulle.dy += bulle.buoy
            bulle.dx *= g_drag
            bulle.dy *= g_drag
        end


        for index = #g_bubbles, 1, -1 do
            if g_bubbles[index].y < g_sea_level then
                deli(g_bubbles, index)
            elseif g_bubbles[index].y > 128 + 15 then
                deli(g_bubbles, index)
            end
        end

        if btn(4) then 
            bbl(64, 126, 0, 0, g_buoy, 5)
        end
    elseif g_state==c_state_text then
        updatetete()
    end
end

function _draw()
    cls(1)

    if g_state==c_state_title then
        print("\^w\^tshitty bubble\n  toy quest",16,16,7)
        print("by @marechalbanane,\n   @antonmakesgames,\n   @jirolondon",30,90,7)
    elseif g_state==c_state_game then
        local mapi=g_leveli-1
        map(mapi*16,mapi\8)

        for index=1,#g_bubbles do
            bulle = g_bubbles[index]
            circ(bulle.x, bulle.y, bulle.radius, 7)
        end

        line(0,g_sea_level, 127, g_sea_level, 7)

        -- triggers
        local triggers=c_levels[g_leveli].triggers
        if triggers then
            for trigger in all(triggers) do
                local x,y,hw,hh=trigger.x,trigger.y,trigger.w/2,trigger.h/2
                rect(x-hw,y-hh,x+hw,y+hh,11)
            end
        end
    elseif g_state==c_state_text then
        drawtete()
    end
end

__gfx__
00000000222222222222222200000000222222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000222222222222222000000000022222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700222222222222220000000000002222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000222222222222200000000000000222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000222222222222000000000000000022220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700222222222220000000000000000002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000222222222200000000000000000000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000222222222000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102000004010101010101020000040100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100010101000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
